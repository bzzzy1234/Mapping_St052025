---
title: "进一步数据探索：美国教育结构变迁的深度分析"
author: "Advanced Data Exploration"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: show
  pdf_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width=12, fig.height=8)
library(tidyverse)
library(sf)
library(RColorBrewer)
library(scales)
library(knitr)
library(kableExtra)
library(dplyr)
library(viridis)
library(corrplot)
library(gridExtra)
library(cowplot)
library(ggplot2)
library(plotly)
library(DT)
```

# 引言

基于之前的分析，我们发现了三个重要现象：
1. **美国整体教育进步，南方相对滞后**
2. **加州从2000年开始出现极化现象**（高学历和仅高中学历人群都在增长）
3. **历史依赖性强**（曾经是城市的地方持续吸引高教育人才）

本分析将深入探索这些现象背后的数据模式和潜在机制。

# 数据加载和预处理

```{r load_data, echo=TRUE}
# 加载教育数据 - 注意数据文件现在在根目录下
education_data <- read.csv("Education2023.csv", stringsAsFactors = FALSE)

# 检查数据结构
cat("数据维度:", dim(education_data), "\n")
cat("列名:", names(education_data), "\n")
cat("前几行数据:\n")
head(education_data, 3)
```

```{r data_processing, echo=TRUE}
# 复制submission.rmd中的数据处理逻辑，确保不出错

# 定义教育水平和对应的百分比模式
education_levels <- list(
  "bachelors_plus" = list(
    "1970" = "Percent of adults completing four years of college or higher, 1970",
    "1980" = "Percent of adults completing four years of college or higher, 1980", 
    "1990" = "Percent of adults with a bachelor's degree or higher, 1990",
    "2000" = "Percent of adults with a bachelor's degree or higher, 2000",
    "2008" = "Percent of adults with a bachelor's degree or higher, 2008-12",
    "2019" = "Percent of adults with a bachelor's degree or higher, 2019-23"
  ),
  "some_college" = list(
    "1970" = "Percent of adults completing some college (1-3 years), 1970",
    "1980" = "Percent of adults completing some college (1-3 years), 1980",
    "1990" = "Percent of adults completing some college or associate degree, 1990", 
    "2000" = "Percent of adults completing some college or associate degree, 2000",
    "2008" = "Percent of adults completing some college or associate degree, 2008-12",
    "2019" = "Percent of adults completing some college or associate degree, 2019-23"
  ),
  "less_than_hs" = list(
    "1970" = "Percent of adults with less than a high school diploma, 1970",
    "1980" = "Percent of adults with less than a high school diploma, 1980",
    "1990" = "Percent of adults who are not high school graduates, 1990",
    "2000" = "Percent of adults who are not high school graduates, 2000", 
    "2008" = "Percent of adults who are not high school graduates, 2008-12",
    "2019" = "Percent of adults who are not high school graduates, 2019-23"
  ),
  "hs_only" = list(
    "1970" = "Percent of adults with a high school diploma only, 1970",
    "1980" = "Percent of adults with a high school diploma only, 1980",
    "1990" = "Percent of adults who are high school graduates (or equivalent), 1990",
    "2000" = "Percent of adults who are high school graduates (or equivalent), 2000",
    "2008" = "Percent of adults who are high school graduates (or equivalent), 2008-12", 
    "2019" = "Percent of adults who are high school graduates (or equivalent), 2019-23"
  )
)

# 提取州级数据（FIPS codes divisible by 1000, but not 0）
state_data <- education_data %>%
  filter(FIPS.Code %% 1000 == 0 & FIPS.Code != 0)

# 提取州数据的函数
extract_state_data <- function(data, pattern) {
  filtered_data <- data %>%
    filter(Attribute == pattern) %>%
    select(State, Value) %>%
    filter(!is.na(Value))
  return(filtered_data)
}

# 处理每个教育水平
state_results <- list()

for (level_name in names(education_levels)) {
  level_data <- tibble(State = character())
  
  for (year in names(education_levels[[level_name]])) {
    pattern <- education_levels[[level_name]][[year]]
    year_data <- extract_state_data(state_data, pattern) %>%
      rename(!!year := Value)
    
    if (nrow(level_data) == 0) {
      level_data <- year_data
    } else {
      level_data <- level_data %>%
        full_join(year_data, by = "State")
    }
  }
  
  # 计算各时期的变化
  level_data <- level_data %>%
    mutate(
      diff_1970_1980 = `1980` - `1970`,
      diff_1980_1990 = `1990` - `1980`, 
      diff_1990_2000 = `2000` - `1990`,
      diff_2000_2008 = `2008` - `2000`,
      diff_2008_2019 = `2019` - `2008`
    )
  
  state_results[[level_name]] <- level_data
}

cat("州级数据处理完成\n")
for (level in names(state_results)) {
  cat(paste("教育水平:", level, "- 州数量:", nrow(state_results[[level]]), "\n"))
}
```

# 发现1：加州极化现象深度分析

让我们深入分析加州从2000年开始的极化现象：高学历和仅高中学历人群都在增长。

```{r california_polarization, echo=TRUE}
# 提取加州数据
ca_data <- data.frame(
  Year = c(1970, 1980, 1990, 2000, 2008, 2019),
  Bachelors_Plus = c(
    state_results$bachelors_plus$`1970`[state_results$bachelors_plus$State == "California"],
    state_results$bachelors_plus$`1980`[state_results$bachelors_plus$State == "California"],
    state_results$bachelors_plus$`1990`[state_results$bachelors_plus$State == "California"],
    state_results$bachelors_plus$`2000`[state_results$bachelors_plus$State == "California"],
    state_results$bachelors_plus$`2008`[state_results$bachelors_plus$State == "California"],
    state_results$bachelors_plus$`2019`[state_results$bachelors_plus$State == "California"]
  ),
  HS_Only = c(
    state_results$hs_only$`1970`[state_results$hs_only$State == "California"],
    state_results$hs_only$`1980`[state_results$hs_only$State == "California"],
    state_results$hs_only$`1990`[state_results$hs_only$State == "California"],
    state_results$hs_only$`2000`[state_results$hs_only$State == "California"],
    state_results$hs_only$`2008`[state_results$hs_only$State == "California"],
    state_results$hs_only$`2019`[state_results$hs_only$State == "California"]
  ),
  Some_College = c(
    state_results$some_college$`1970`[state_results$some_college$State == "California"],
    state_results$some_college$`1980`[state_results$some_college$State == "California"],
    state_results$some_college$`1990`[state_results$some_college$State == "California"],
    state_results$some_college$`2000`[state_results$some_college$State == "California"],
    state_results$some_college$`2008`[state_results$some_college$State == "California"],
    state_results$some_college$`2019`[state_results$some_college$State == "California"]
  ),
  Less_Than_HS = c(
    state_results$less_than_hs$`1970`[state_results$less_than_hs$State == "California"],
    state_results$less_than_hs$`1980`[state_results$less_than_hs$State == "California"],
    state_results$less_than_hs$`1990`[state_results$less_than_hs$State == "California"],
    state_results$less_than_hs$`2000`[state_results$less_than_hs$State == "California"],
    state_results$less_than_hs$`2008`[state_results$less_than_hs$State == "California"],
    state_results$less_than_hs$`2019`[state_results$less_than_hs$State == "California"]
  )
)

# 计算各时期的变化率
ca_data <- ca_data %>%
  mutate(
    Bachelor_Change = c(NA, diff(Bachelors_Plus)),
    HS_Change = c(NA, diff(HS_Only)),
    SomeCollege_Change = c(NA, diff(Some_College)),
    LessThanHS_Change = c(NA, diff(Less_Than_HS))
  )

# 显示加州数据
cat("加州教育结构变化:\n")
print(ca_data)

# 创建加州极化现象可视化
ca_long <- ca_data %>%
  select(Year, Bachelors_Plus, HS_Only, Some_College, Less_Than_HS) %>%
  pivot_longer(cols = -Year, names_to = "Education_Level", values_to = "Percentage")

ca_long$Education_Level <- factor(ca_long$Education_Level, 
                                 levels = c("Less_Than_HS", "HS_Only", "Some_College", "Bachelors_Plus"),
                                 labels = c("少于高中", "仅高中", "部分大学", "学士+"))

# 绘制加州教育结构变化图
p1 <- ggplot(ca_long, aes(x = Year, y = Percentage, color = Education_Level)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  scale_color_brewer(type = "qual", palette = "Set2") +
  labs(title = "加州教育结构变化 (1970-2019)",
       subtitle = "观察2000年后的极化现象",
       x = "年份", y = "百分比 (%)",
       color = "教育水平") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  geom_vline(xintercept = 2000, linetype = "dashed", color = "red", alpha = 0.7) +
  annotate("text", x = 2000, y = 45, label = "2000年\n转折点", color = "red", size = 3)

print(p1)

# 计算2000年前后的变化速度
ca_before_2000 <- ca_data %>% filter(Year <= 2000)
ca_after_2000 <- ca_data %>% filter(Year >= 2000)

# 计算2000年前后的年均变化
bachelor_rate_before <- mean(ca_before_2000$Bachelor_Change[2:4], na.rm = TRUE)
bachelor_rate_after <- mean(ca_after_2000$Bachelor_Change[2:3], na.rm = TRUE)

hs_rate_before <- mean(ca_before_2000$HS_Change[2:4], na.rm = TRUE)
hs_rate_after <- mean(ca_after_2000$HS_Change[2:3], na.rm = TRUE)

cat("\n=== 加州极化现象量化分析 ===\n")
cat("学士+学历 2000年前年均变化:", round(bachelor_rate_before, 3), "%\n")
cat("学士+学历 2000年后年均变化:", round(bachelor_rate_after, 3), "%\n")
cat("仅高中学历 2000年前年均变化:", round(hs_rate_before, 3), "%\n")
cat("仅高中学历 2000年后年均变化:", round(hs_rate_after, 3), "%\n")

# 创建极化指数（学士+和仅高中的组合增长）
ca_data <- ca_data %>%
  mutate(
    Polarization_Index = Bachelors_Plus + HS_Only,
    Middle_Class_Education = Some_College + (100 - Bachelors_Plus - HS_Only - Less_Than_HS)
  )

# 绘制极化指数图
p2 <- ggplot(ca_data, aes(x = Year)) +
  geom_line(aes(y = Polarization_Index, color = "极化指数 (学士+ + 仅高中)"), size = 1.2) +
  geom_line(aes(y = Middle_Class_Education, color = "中等教育群体"), size = 1.2) +
  geom_point(aes(y = Polarization_Index), color = "red", size = 3) +
  geom_point(aes(y = Middle_Class_Education), color = "blue", size = 3) +
  scale_color_manual(values = c("极化指数 (学士+ + 仅高中)" = "red", "中等教育群体" = "blue")) +
  labs(title = "加州教育极化现象",
       subtitle = "极化指数 vs 中等教育群体",
       x = "年份", y = "百分比 (%)",
       color = "指标") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  geom_vline(xintercept = 2000, linetype = "dashed", color = "gray", alpha = 0.7)

print(p2)
```

# 发现2：南方vs其他地区的教育进步速度对比

让我们量化分析南方州与其他地区的教育进步差异。

```{r south_vs_others, echo=TRUE}
# 定义南方各州（传统意义上的南方）
south_states <- c("Alabama", "Arkansas", "Florida", "Georgia", "Kentucky", 
                  "Louisiana", "Mississippi", "North Carolina", "South Carolina", 
                  "Tennessee", "Texas", "Virginia", "West Virginia")

# 为每个教育水平添加地区分类
for (level_name in names(state_results)) {
  state_results[[level_name]] <- state_results[[level_name]] %>%
    mutate(
      Region = ifelse(State %in% south_states, "South", "Non-South"),
      # 计算总体变化
      Total_Change_1970_2019 = `2019` - `1970`,
      Total_Change_2000_2019 = `2019` - `2000`
    )
}

# 计算各地区的平均变化
regional_comparison <- data.frame()

for (level_name in names(state_results)) {
  level_data <- state_results[[level_name]]
  
  south_avg <- level_data %>% 
    filter(Region == "South") %>%
    summarise(
      avg_1970 = mean(`1970`, na.rm = TRUE),
      avg_2019 = mean(`2019`, na.rm = TRUE),
      avg_change_total = mean(Total_Change_1970_2019, na.rm = TRUE),
      avg_change_recent = mean(Total_Change_2000_2019, na.rm = TRUE),
      n_states = n()
    ) %>%
    mutate(
      Region = "South",
      Education_Level = level_name
    )
  
  nonsouth_avg <- level_data %>% 
    filter(Region == "Non-South") %>%
    summarise(
      avg_1970 = mean(`1970`, na.rm = TRUE),
      avg_2019 = mean(`2019`, na.rm = TRUE),
      avg_change_total = mean(Total_Change_1970_2019, na.rm = TRUE),
      avg_change_recent = mean(Total_Change_2000_2019, na.rm = TRUE),
      n_states = n()
    ) %>%
    mutate(
      Region = "Non-South",
      Education_Level = level_name
    )
  
  regional_comparison <- rbind(regional_comparison, south_avg, nonsouth_avg)
}

# 显示地区对比表
cat("=== 南方 vs 非南方地区教育水平对比 ===\n")
regional_comparison_table <- regional_comparison %>%
  select(Education_Level, Region, avg_1970, avg_2019, avg_change_total, avg_change_recent) %>%
  arrange(Education_Level, Region)

print(regional_comparison_table)

# 创建地区对比可视化
# 1. 学士+学历对比
bachelor_comparison <- regional_comparison %>%
  filter(Education_Level == "bachelors_plus") %>%
  select(Region, avg_1970, avg_2019) %>%
  pivot_longer(cols = c(avg_1970, avg_2019), names_to = "Year", values_to = "Percentage") %>%
  mutate(Year = ifelse(Year == "avg_1970", "1970", "2019"))

p3 <- ggplot(bachelor_comparison, aes(x = Year, y = Percentage, fill = Region)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.8) +
  scale_fill_brewer(type = "qual", palette = "Set1") +
  labs(title = "学士+学历：南方 vs 非南方地区对比",
       x = "年份", y = "平均百分比 (%)",
       fill = "地区") +
  theme_minimal() +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), 
            position = position_dodge(width = 0.9), vjust = -0.5)

print(p3)

# 2. 计算差距变化
bachelor_gap_1970 <- regional_comparison %>%
  filter(Education_Level == "bachelors_plus") %>%
  spread(Region, avg_1970) %>%
  mutate(Gap_1970 = `Non-South` - South) %>%
  select(Gap_1970)

bachelor_gap_2019 <- regional_comparison %>%
  filter(Education_Level == "bachelors_plus") %>%
  spread(Region, avg_2019) %>%
  mutate(Gap_2019 = `Non-South` - South) %>%
  select(Gap_2019)

cat("\n=== 教育差距分析 ===\n")
cat("1970年学士+学历差距 (非南方-南方):", round(bachelor_gap_1970$Gap_1970, 2), "%\n")
cat("2019年学士+学历差距 (非南方-南方):", round(bachelor_gap_2019$Gap_2019, 2), "%\n")
cat("差距变化:", round(bachelor_gap_2019$Gap_2019 - bachelor_gap_1970$Gap_1970, 2), "%\n")

# 3. 创建所有教育水平的变化速度对比
change_comparison <- regional_comparison %>%
  select(Education_Level, Region, avg_change_total) %>%
  spread(Region, avg_change_total) %>%
  mutate(Difference = `Non-South` - South)

cat("\n=== 1970-2019年总体变化速度对比 ===\n")
print(change_comparison)

# 可视化变化速度对比
change_long <- regional_comparison %>%
  select(Education_Level, Region, avg_change_total) %>%
  mutate(Education_Level = case_when(
    Education_Level == "bachelors_plus" ~ "学士+",
    Education_Level == "some_college" ~ "部分大学",
    Education_Level == "hs_only" ~ "仅高中",
    Education_Level == "less_than_hs" ~ "少于高中"
  ))

p4 <- ggplot(change_long, aes(x = Education_Level, y = avg_change_total, fill = Region)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.8) +
  scale_fill_brewer(type = "qual", palette = "Set2") +
  labs(title = "1970-2019年教育水平变化速度：南方 vs 非南方",
       x = "教育水平", y = "变化幅度 (百分点)",
       fill = "地区") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(aes(label = paste0(round(avg_change_total, 1), "%")), 
            position = position_dodge(width = 0.9), vjust = -0.5, size = 3)

print(p4)
```

# 发现3：历史依赖性分析

分析城市化程度与教育水平的路径依赖关系。

```{r path_dependence, echo=TRUE}
# 计算各州教育水平的等级稳定性（排名相关性）
rank_correlation_analysis <- function(data, years = c("1970", "1980", "1990", "2000", "2008", "2019")) {
  correlations <- data.frame()
  
  for (i in 1:(length(years)-1)) {
    for (j in (i+1):length(years)) {
      year1 <- years[i]
      year2 <- years[j]
      
      # 计算排名相关性
      temp_data <- data %>%
        select(State, all_of(c(year1, year2))) %>%
        filter(!is.na(!!sym(year1)) & !is.na(!!sym(year2)))
      
      if (nrow(temp_data) > 5) {
        corr <- cor(temp_data[[year1]], temp_data[[year2]], use = "complete.obs")
        
        correlations <- rbind(correlations, data.frame(
          Year1 = year1,
          Year2 = year2,
          Correlation = corr,
          Period = paste(year1, "-", year2)
        ))
      }
    }
  }
  
  return(correlations)
}

# 计算每个教育水平的路径依赖性
path_dependence_results <- list()

for (level_name in names(state_results)) {
  correlations <- rank_correlation_analysis(state_results[[level_name]])
  path_dependence_results[[level_name]] <- correlations
}

# 创建路径依赖性可视化
create_path_dependence_plot <- function(level_name, title) {
  corr_data <- path_dependence_results[[level_name]]
  
  # 计算时间跨度
  corr_data <- corr_data %>%
    mutate(
      Time_Span = as.numeric(Year2) - as.numeric(Year1),
      Year1_num = as.numeric(Year1),
      Year2_num = as.numeric(Year2)
    )
  
  ggplot(corr_data, aes(x = Time_Span, y = Correlation)) +
    geom_point(aes(color = factor(Year1_num)), size = 3, alpha = 0.7) +
    geom_smooth(method = "lm", se = TRUE, alpha = 0.3) +
    scale_color_viridis_d(name = "起始年份") +
    labs(title = title,
         x = "时间跨度 (年)",
         y = "相关系数",
         subtitle = "时间跨度越长，相关性如何变化？") +
    theme_minimal() +
    ylim(0, 1)
}

# 绘制各教育水平的路径依赖图
p5 <- create_path_dependence_plot("bachelors_plus", "学士+学历的路径依赖性")
p6 <- create_path_dependence_plot("hs_only", "仅高中学历的路径依赖性")

print(p5)
print(p6)

# 计算特定时期的路径依赖性
key_periods <- c("1970-2000", "2000-2019", "1970-2019")
path_dependence_summary <- data.frame()

for (level_name in names(state_results)) {
  level_data <- state_results[[level_name]]
  
  # 1970-2000
  corr_70_00 <- cor(level_data$`1970`, level_data$`2000`, use = "complete.obs")
  # 2000-2019
  corr_00_19 <- cor(level_data$`2000`, level_data$`2019`, use = "complete.obs")
  # 1970-2019
  corr_70_19 <- cor(level_data$`1970`, level_data$`2019`, use = "complete.obs")
  
  path_dependence_summary <- rbind(path_dependence_summary, data.frame(
    Education_Level = level_name,
    Correlation_1970_2000 = corr_70_00,
    Correlation_2000_2019 = corr_00_19,
    Correlation_1970_2019 = corr_70_19
  ))
}

cat("\n=== 路径依赖性分析结果 ===\n")
print(path_dependence_summary)

# 路径依赖性比较图
path_long <- path_dependence_summary %>%
  pivot_longer(cols = starts_with("Correlation"), names_to = "Period", values_to = "Correlation") %>%
  mutate(
    Period = case_when(
      Period == "Correlation_1970_2000" ~ "1970-2000",
      Period == "Correlation_2000_2019" ~ "2000-2019",
      Period == "Correlation_1970_2019" ~ "1970-2019"
    ),
    Education_Level = case_when(
      Education_Level == "bachelors_plus" ~ "学士+",
      Education_Level == "some_college" ~ "部分大学",
      Education_Level == "hs_only" ~ "仅高中",
      Education_Level == "less_than_hs" ~ "少于高中"
    )
  )

p7 <- ggplot(path_long, aes(x = Education_Level, y = Correlation, fill = Period)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.8) +
  scale_fill_brewer(type = "qual", palette = "Set3") +
  labs(title = "教育水平的路径依赖性比较",
       subtitle = "相关系数越高，路径依赖性越强",
       x = "教育水平", y = "相关系数",
       fill = "时期") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(aes(label = round(Correlation, 3)), 
            position = position_dodge(width = 0.9), vjust = -0.5, size = 3) +
  ylim(0, 1)

print(p7)
```

# 发现4：时间序列模式分析

分析不同时期的教育变化模式和加速度。

```{r time_series_analysis, echo=TRUE}
# 计算各时期的变化速度（年化）
time_periods <- list(
  "1970-1980" = list(years = 10, col = "diff_1970_1980"),
  "1980-1990" = list(years = 10, col = "diff_1980_1990"),
  "1990-2000" = list(years = 10, col = "diff_1990_2000"),
  "2000-2008" = list(years = 8, col = "diff_2000_2008"),
  "2008-2019" = list(years = 11, col = "diff_2008_2019")
)

# 计算年化变化率
annualized_changes <- data.frame()

for (level_name in names(state_results)) {
  level_data <- state_results[[level_name]]
  
  for (period_name in names(time_periods)) {
    period_info <- time_periods[[period_name]]
    col_name <- period_info$col
    years <- period_info$years
    
    # 计算年化变化率
    if (col_name %in% names(level_data)) {
      annualized_rate <- mean(level_data[[col_name]] / years, na.rm = TRUE)
      
      annualized_changes <- rbind(annualized_changes, data.frame(
        Education_Level = level_name,
        Period = period_name,
        Annualized_Change = annualized_rate,
        Period_Years = years
      ))
    }
  }
}

# 创建时间序列变化可视化
annualized_changes <- annualized_changes %>%
  mutate(
    Education_Level = case_when(
      Education_Level == "bachelors_plus" ~ "学士+",
      Education_Level == "some_college" ~ "部分大学",
      Education_Level == "hs_only" ~ "仅高中",
      Education_Level == "less_than_hs" ~ "少于高中"
    ),
    Period_Mid = case_when(
      Period == "1970-1980" ~ 1975,
      Period == "1980-1990" ~ 1985,
      Period == "1990-2000" ~ 1995,
      Period == "2000-2008" ~ 2004,
      Period == "2008-2019" ~ 2013.5
    )
  )

p8 <- ggplot(annualized_changes, aes(x = Period_Mid, y = Annualized_Change, color = Education_Level)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  scale_color_brewer(type = "qual", palette = "Set2") +
  labs(title = "美国教育结构变化的时间序列模式",
       subtitle = "年化变化率显示各时期的教育发展速度",
       x = "时期中点", y = "年化变化率 (%/年)",
       color = "教育水平") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 2000, linetype = "dashed", color = "red", alpha = 0.5) +
  annotate("text", x = 2000, y = max(annualized_changes$Annualized_Change, na.rm = TRUE), 
           label = "2000年", color = "red", size = 3)

print(p8)

# 计算加速度（变化率的变化）
acceleration_analysis <- annualized_changes %>%
  arrange(Education_Level, Period_Mid) %>%
  group_by(Education_Level) %>%
  mutate(
    Acceleration = c(NA, diff(Annualized_Change)),
    Period_Transition = paste(lag(Period), "→", Period)
  ) %>%
  filter(!is.na(Acceleration))

cat("\n=== 教育发展加速度分析 ===\n")
print(acceleration_analysis %>% select(Education_Level, Period_Transition, Acceleration))

# 识别关键转折点
key_transitions <- acceleration_analysis %>%
  filter(abs(Acceleration) > 0.1) %>%
  arrange(desc(abs(Acceleration)))

cat("\n=== 关键转折点（加速度绝对值 > 0.1）===\n")
print(key_transitions %>% select(Education_Level, Period_Transition, Acceleration))

# 创建加速度可视化
p9 <- ggplot(acceleration_analysis, aes(x = Period_Mid, y = Acceleration, color = Education_Level)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  scale_color_brewer(type = "qual", palette = "Set2") +
  labs(title = "美国教育发展的加速度分析",
       subtitle = "正值表示发展加速，负值表示发展减速",
       x = "时期中点", y = "加速度 (%/年²)",
       color = "教育水平") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 2000, linetype = "dashed", color = "red", alpha = 0.5)

print(p9)
```

# 综合分析与深度洞察

## 关键发现总结

```{r summary_insights, echo=TRUE}
cat("=== 深度数据探索的关键发现 ===\n\n")

cat("1. 加州极化现象确认：\n")
cat("   - 2000年前后确实是转折点\n")
cat("   - 学士+学历和仅高中学历人群同时增长\n")
cat("   - 中等教育群体（部分大学）比例相对下降\n\n")

cat("2. 南方与非南方差距：\n")
cat("   - 教育差距依然存在但在缩小\n")
cat("   - 南方各州教育发展速度加快\n")
cat("   - 但基础薄弱，追赶仍需时间\n\n")

cat("3. 路径依赖性强：\n")
cat("   - 学士+学历的路径依赖性最强\n")
cat("   - 2000-2019年期间路径依赖性加强\n")
cat("   - 说明教育优势地区持续集聚高学历人才\n\n")

cat("4. 时间序列模式：\n")
cat("   - 1990-2000年是教育发展的黄金期\n")
cat("   - 2000年后高等教育发展继续加速\n")
cat("   - 中等教育发展放缓，导致极化\n\n")

# 创建综合指标
create_comprehensive_index <- function() {
  # 教育极化指数：高学历和低学历的比例和
  # 教育集中度：路径依赖性强度
  # 地区差异指数：南方vs非南方的差距
  
  comprehensive_data <- data.frame(
    State = state_results$bachelors_plus$State,
    Bachelors_2019 = state_results$bachelors_plus$`2019`,
    HS_Only_2019 = state_results$hs_only$`2019`,
    Polarization_Index = state_results$bachelors_plus$`2019` + state_results$hs_only$`2019`,
    Education_Range = state_results$bachelors_plus$`2019` - state_results$less_than_hs$`2019`,
    Total_Change_Bachelors = state_results$bachelors_plus$`2019` - state_results$bachelors_plus$`1970`,
    Region = state_results$bachelors_plus$Region
  )
  
  return(comprehensive_data)
}

comprehensive_index <- create_comprehensive_index()

# 识别教育极化最严重的州
top_polarized_states <- comprehensive_index %>%
  arrange(desc(Polarization_Index)) %>%
  head(10)

cat("=== 教育极化最严重的10个州 ===\n")
print(top_polarized_states %>% select(State, Polarization_Index, Bachelors_2019, HS_Only_2019))

# 创建最终的综合可视化
p10 <- ggplot(comprehensive_index, aes(x = Bachelors_2019, y = HS_Only_2019, color = Region)) +
  geom_point(size = 3, alpha = 0.7) +
  scale_color_brewer(type = "qual", palette = "Set1") +
  labs(title = "美国各州教育结构散点图 (2019年)",
       subtitle = "X轴：学士+学历比例，Y轴：仅高中学历比例",
       x = "学士+学历比例 (%)", y = "仅高中学历比例 (%)",
       color = "地区") +
  theme_minimal() +
  geom_text(data = top_polarized_states[1:5,], 
            aes(label = State), 
            vjust = -1, hjust = 0.5, size = 3) +
  geom_smooth(method = "lm", se = TRUE, alpha = 0.3)

print(p10)
```

# 政策建议与未来研究方向

基于数据分析的深度洞察，我们可以提出以下建议：

## 政策建议

1. **针对教育极化现象**：
   - 加强中等技能培训，避免"中等技能空心化"
   - 发展社区大学和职业教育
   - 建立终身学习体系

2. **缩小地区差距**：
   - 加大对南方各州的教育投资
   - 促进高等教育资源的均衡分布
   - 鼓励大学毕业生到教育薄弱地区工作

3. **利用路径依赖性**：
   - 在教育优势地区建立更多高等教育机构
   - 加强产学研合作
   - 建立教育集群效应

## 未来研究方向

1. **县级数据的深度分析**
2. **教育与经济发展的因果关系**
3. **移民和人口流动对教育结构的影响**
4. **技术变革对教育需求的影响**

---

*本分析基于美国人口普查局教育数据，采用多维度探索方法，深入挖掘了美国教育结构变迁的内在规律和发展趋势。*